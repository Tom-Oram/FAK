name: first-aid-kit

services:
  # First Aid Kit Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fak-frontend
    ports:
      - "8081:80"
    networks:
      - fak-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    depends_on:
      - pathtrace-api
      - iperf-api

  # Path Tracer API (Python Flask)
  pathtrace-api:
    build:
      context: ./services/pathtrace-api
      dockerfile: Dockerfile
    container_name: fak-pathtrace-api
    ports:
      - "5000:5000"
    environment:
      FLASK_ENV: production
      NETBOX_URL: ${NETBOX_URL:-}
      NETBOX_TOKEN: ${NETBOX_TOKEN:-}
      # Path tracer credentials
      PATHTRACE_USER: ${PATHTRACE_USER:-}
      PATHTRACE_PASS: ${PATHTRACE_PASS:-}
      PATHTRACE_SECRET: ${PATHTRACE_SECRET:-}
      PATHTRACE_INVENTORY: /app/pathtracer/inventory.yaml
    volumes:
      # Mount inventory and credentials from host (create these files first)
      - ./services/pathtrace-api/pathtracer/inventory.yaml:/app/pathtracer/inventory.yaml:ro
      - ./services/pathtrace-api/pathtracer/credentials.yaml:/app/pathtracer/credentials.yaml:ro
    cap_add:
      - NET_RAW
      - NET_ADMIN
    security_opt:
      - no-new-privileges:true
    networks:
      - fak-network
    restart: unless-stopped

  # iPerf Server API (Go)
  iperf-api:
    build:
      context: ./services/iperf-api
      dockerfile: Dockerfile
    container_name: fak-iperf-api
    ports:
      - "8082:8080"
      - "5201:5201"
      - "5202:5202"
      - "5203:5203"
      - "5204:5204"
      - "5205:5205"
    volumes:
      - iperf-data:/app/data
    environment:
      DATA_DIR: /app/data
      PORT: "8080"
      IPERF_PORT_MIN: "5201"
      IPERF_PORT_MAX: "5205"
    networks:
      - fak-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

networks:
  fak-network:
    driver: bridge

volumes:
  iperf-data:
