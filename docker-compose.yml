name: first-aid-kit

services:
  # First Aid Kit Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fak-frontend
    ports:
      - "8081:80"
    networks:
      - fak-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    depends_on:
      - backend
      - iperf-backend

  # First Aid Kit Backend API (Traceroute)
  backend:
    build:
      context: .
      dockerfile: ./api/Dockerfile
    container_name: fak-backend
    ports:
      - "5000:5000"
    environment:
      FLASK_ENV: production
      NETBOX_URL: ${NETBOX_URL:-}
      NETBOX_TOKEN: ${NETBOX_TOKEN:-}
      # Path tracer credentials
      PATHTRACE_USER: ${PATHTRACE_USER:-}
      PATHTRACE_PASS: ${PATHTRACE_PASS:-}
      PATHTRACE_SECRET: ${PATHTRACE_SECRET:-}
      PATHTRACE_INVENTORY: /app/pathtracer/inventory.yaml
    volumes:
      # Mount inventory and credentials from host (create these files first)
      - ./pathtracer/inventory.yaml:/app/pathtracer/inventory.yaml:ro
      - ./pathtracer/credentials.yaml:/app/pathtracer/credentials.yaml:ro
    cap_add:
      - NET_RAW
      - NET_ADMIN
    security_opt:
      - no-new-privileges:true
    networks:
      - fak-network
    restart: unless-stopped

  # iPerf Server Backend (Go)
  iperf-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fak-iperf-backend
    ports:
      - "8082:8080"
      - "5201:5201"
      - "5202:5202"
      - "5203:5203"
      - "5204:5204"
      - "5205:5205"
    volumes:
      - iperf-data:/app/data
    environment:
      DATA_DIR: /app/data
      PORT: "8080"
      IPERF_PORT_MIN: "5201"
      IPERF_PORT_MAX: "5205"
    networks:
      - fak-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

networks:
  fak-network:
    driver: bridge

volumes:
  iperf-data:
